<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>HBTRKR</title>
  <link rel="icon" href="ico.jpg">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --gold:#FFD700; --gold-deep:#C9A227; --bg:#0b0c10; --panel:#0b0c10; --text:#e6eef8; }
    body { background: var(--bg); color: var(--text); }
    .month-grid { grid-template-columns: repeat(3, minmax(0,1fr)); }
    .day-cell { width: 1.6rem; height: 1.6rem; display:flex;align-items:center;justify-content:center;border-radius:.35rem; transition: background-color 0.2s, transform .12s; }
    .day-cell:hover { transform: translateY(-2px); }
    .gold { box-shadow: 0 0 16px rgba(255,215,0,0.35), inset 0 0 0 1px rgba(255,215,0,0.45); border: 1px solid rgba(255,215,0,0.55); }
    .gold-bg { background: linear-gradient(135deg, var(--gold), var(--gold-deep)); padding: .12rem .5rem; border-radius: .45rem; color: #0a0a0a; font-weight:700; box-shadow: 0 0 18px rgba(255,215,0,.28); }
    .gold-chip { background: linear-gradient(135deg, var(--gold), var(--gold-deep)); color:#0a0a0a; font-weight:700; border:1px solid rgba(255,215,0,.55); box-shadow: 0 0 18px rgba(255,215,0,.28); }
    .streak-badge{ padding:.12rem .45rem; border-radius:.45rem; font-weight:600; font-size:.8rem; border:1px solid rgba(255,255,255,.18); color: rgba(255,255,255,.9); }
    .streak-badge--best{ background: linear-gradient(135deg, var(--gold), var(--gold-deep)); color:#0a0a0a; border-color: rgba(255,215,0,.55); box-shadow: 0 0 18px rgba(255,215,0,.28); }
    .bar { width: 100%; border-radius: 3px 3px 0 0; background: linear-gradient(180deg, var(--gold), var(--gold-deep)); }
    .bar-muted { background: rgba(255,255,255,.15); }
    .chip { font-size:.75rem; padding:.2rem .5rem; border-radius:.4rem; border:1px solid rgba(255,255,255,.15); display:inline-flex; align-items:center; gap:.3rem; }
    .chip-neutral{ background: rgba(255,255,255,.06); color:#e6eef8; }
    .chip-up{ background: rgba(34,197,94,.15); color:#d1fae5; }
    .chip-down{ background: rgba(239,68,68,.15); color:#fee2e2; }
    ::-webkit-scrollbar{width:8px;height:8px}
    ::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.06);border-radius:8px}
  </style>
</head>
<body class="antialiased min-h-screen">
  <header class="fixed top-0 left-0 right-0 z-40 backdrop-blur-md bg-gradient-to-b from-black/40 to-transparent border-b border-white/5">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2 sm:gap-4">
        <button id="appTitle" class="text-lg  font-extrabold tracking-wide hover:opacity-80">HBTRKR</button>
      </div>
      <div class="flex items-center gap-3">
        <button id="importBtn" class="text-sm px-3 py-1 rounded hover:bg-white/5">Importer</button>
        <button id="exportBtn" class="text-sm px-3 py-1 rounded hover:bg-white/5">Exporter</button>
        <button id="addHabitBtn" class="text-sm bg-white/10 px-3 py-1 rounded hover:bg-white/15">+ Habitude</button>
      </div>
    </div>
  </header>

  <main id="homePage" class="pt-20 pb-24 max-w-5xl mx-auto px-4 space-y-10 overflow-auto" style="scroll-behavior: smooth;"></main>

  <!-- Overlay pour le panneau Day (clic extérieur pour fermer) -->
  <div id="dayOverlay" class="hidden fixed inset-0 z-40 bg-black/30"></div>

  <div id="dayPanel" class="hidden md:block fixed right-4 top-20 z-50 w-96 max-w-full bg-[var(--panel)] border border-white/10 rounded-2xl shadow-2xl p-4 translate-x-full transition-transform duration-300">
    <div class="flex items-start justify-between mb-3">
      <div>
        <div id="panelDate" class="text-sm font-semibold">Jour</div>
        <div id="panelDateLong" class="text-xs text-white/60">date</div>
      </div>
      <!-- Bouton Fermer masqué à la demande -->
      <button id="closePanel" class="hidden text-sm px-2 py-1 rounded hover:bg-white/5">Fermer</button>
    </div>
    <div id="habitsList" class="space-y-3 max-h-144 overflow-auto pb-2"></div>
  </div>

  <section id="dayPage" class="hidden pt-20 pb-6 max-w-2xl mx-auto px-4 min-h-screen flex flex-col">
    <div class="text-center mb-4">
      <div id="dayTitle" class="text-5xl font-extrabold pt-32 pb-4"></div>
      <div id="dayTitleSub" class="text-sm text-white/60"></div>
    </div>
    <div id="dayContent" class="flex-1"></div>
    <div id="dayHabitsList" class="mb-16 space-y-3 flex flex-col items-center pb-28 sm:pb-0"></div>
    <div class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 sm:static sm:translate-x-0 sm:my-4 flex items-center gap-2 sm:justify-center">
      <div class="flex items-center gap-1 rounded-full border border-white/10 bg-white/5 backdrop-blur px-1.5 py-1 shadow-lg">
        <button id="prevDay" aria-label="Jour précédent" class="h-11 w-11 sm:h-10 sm:w-10 grid place-items-center rounded-full hover:bg-white/10 active:scale-95 transition focus:outline-none focus:ring-2 focus:ring-white/20">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <button id="todayBtn" class="h-11 sm:h-10 px-4 sm:px-5 rounded-full font-semibold text-xs bg-[rgb(0,200,75)] text-black border border-green-400/40 ring-1 ring-green-300/30 hover:brightness-95 active:scale-95 transition focus:outline-none focus:ring-2 focus:ring-green-300/50 flex items-center gap-2">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2" opacity=".7"/><circle cx="12" cy="12" r="4" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="12" r="1.5" fill="currentColor"/></svg>
          <span>Aujourd’hui</span>
        </button>
        <button id="nextDay" aria-label="Jour suivant" class="h-11 w-11 sm:h-10 sm:w-10 grid place-items-center rounded-full hover:bg-white/10 active:scale-95 transition focus:outline-none focus:ring-2 focus:ring-white/20">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
    </div>
  </section>

  <div id="modalAddHabit" class="fixed inset-0 z-60 hidden items-center justify-center bg-black/50" role="dialog" aria-modal="true">
    <div class="bg-[#17181C] border border-white/10 rounded-xl p-4 w-96 shadow-2xl">
      <h3 class="font-semibold mb-2">Ajouter une habitude</h3>
      <input id="habitNameInput" class="w-full p-2 rounded bg-white/5 mb-2" placeholder="Nom de l'Habitude"/>
      <label class="block text-xs text-white/60 mb-2">Active à partir de :</label>
      <input id="habitStartInput" type="date" class="w-full p-2 rounded bg-white/5 mb-3" />
      <div class="flex justify-end gap-2">
        <button id="cancelAddHabit" class="px-3 py-1 rounded hover:bg-white/5">Annuler</button>
        <button id="confirmAddHabit" class="px-3 py-1 bg-white/10 rounded hover:bg-white/15">Ajouter</button>
      </div>
    </div>
  </div>

  <div id="modalMonth" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 p-4">
    <div class="bg-[var(--panel)] border border-white/10 rounded-2xl p-4 w-full max-w-2xl max-h-[85vh] overflow-auto">
      <div class="flex items-center justify-between mb-2">
        <div class="font-bold" id="monthModalTitle">Mois</div>
        <button id="closeMonth" class="px-2 py-1 rounded hover:bg-white/5">Fermer</button>
      </div>
      <p class="text-xs text-white/60 mb-3">Taux de complétion du mois sélectionné et des <span class="font-semibold">2 mois précédents</span>…</p>
      <div id="monthSummary" class="space-y-2"></div>
    </div>
  </div>

  <div id="modalYear" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 p-4">
    <div class="bg-[var(--panel)] border border-white/10 rounded-2xl p-4 w-full max-w-3xl max-h-[85vh] overflow-auto">
      <div class="flex items-center justify-between mb-2">
        <div class="font-bold" id="yearModalTitle">Année</div>
        <button id="closeYear" class="px-2 py-1 rounded hover:bg-white/5">Fermer</button>
      </div>
      <p class="text-xs text-white/60 mb-3">Taux de complétion <span class="font-semibold">mensuel</span>…</p>
      <div id="yearSummary" class="space-y-3"></div>
    </div>
  </div>

  <input id="fileInput" type="file" accept="application/json" class="hidden" />

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
    import { getFirestore, doc, onSnapshot, setDoc, enableIndexedDbPersistence } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

    const firebaseConfig = { apiKey: "AIzaSyBptpMFEMc7ikXM0PtDOeWUHnMegKQ6hcs", authDomain: "habit-8d57f.firebaseapp.com", projectId: "habit-8d57f", storageBucket: "habit-8d57f.appspot.com", messagingSenderId: "934416417831", appId: "1:934416417831:web:63f2f0554daa6d3ff23a02" };

    let data = { habits: [], completions: {}, _rev: 0 };
    let lastLocalRev = 0; let initialSynced = false;

    const caches = { bestStreak:new Map(), monthRate:new Map(), monthlyMax:new Map() };
    const clearAllCaches = ()=>{ caches.bestStreak.clear(); caches.monthRate.clear(); caches.monthlyMax.clear(); };
    const clearHabitCaches = (habitName)=>{ caches.bestStreak.delete(habitName); caches.monthlyMax.delete(habitName); for(const k of caches.monthRate.keys()){ if(k.startsWith(habitName+'|')) caches.monthRate.delete(k); } };
    const clearMonthCacheForHabit = (habitName, y, m)=>{ caches.monthRate.delete(`${habitName}|${y}-${m}`); caches.monthlyMax.delete(habitName); };

    const homePage = document.getElementById('homePage');
    const yearsContainer = homePage;
    const dayPanel = document.getElementById('dayPanel');
    const dayOverlay = document.getElementById('dayOverlay');
    const panelDate = document.getElementById('panelDate');
    const panelDateLong = document.getElementById('panelDateLong');
    const habitsList = document.getElementById('habitsList');

    const dayPage = document.getElementById('dayPage');
    const dayTitle = document.getElementById('dayTitle');
    const dayTitleSub = document.getElementById('dayTitleSub');
    const dayHabitsList = document.getElementById('dayHabitsList');

    const monthModal = document.getElementById('modalMonth');
    const monthSummary = document.getElementById('monthSummary');
    const monthModalTitle = document.getElementById('monthModalTitle');

    const yearModal = document.getElementById('modalYear');
    const yearSummary = document.getElementById('yearSummary');
    const yearModalTitle = document.getElementById('yearModalTitle');

    const appTitle = document.getElementById('appTitle');

    let focusedDateKey = null;
    const now = new Date(); const currentYear = now.getFullYear(); const currentMonth = now.getMonth();
    let minYear = 2025; let maxYear = currentYear + 5; const isSmall = () => window.matchMedia('(max-width: 639px)').matches;

    const formatDateKey = (d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const parseDateKey = (s)=> new Date(s+'T00:00:00');
    const monthNameShort = (m)=> ['Jan','Fév','Mar','Avr','Mai','Jun','Jul','Aoû','Sep','Oct','Nov','Déc'][m];
    const monthNameLong = (m)=> ['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'][m];

    const isHabitActiveOn = (h, dateKey)=>{ const d = parseDateKey(dateKey); const start = new Date(h.startDate+'T00:00:00'); if(d < start) return false; if(h.deletedAt && d >= new Date(h.deletedAt+'T00:00:00')) return false; return true; };

    const getCompletionRate = (dateKey)=>{ const dayData = data.completions[dateKey] || {}; const activeHabits = data.habits.filter(h=>isHabitActiveOn(h,dateKey)); if(activeHabits.length===0) return 0; const completed = activeHabits.filter(h=>dayData[h.name]).length; return completed / activeHabits.length; };

    function computeStreakForHabit(habitName, asOfDateKey){
      let d = parseDateKey(asOfDateKey); let streak = 0; const habit = data.habits.find(h=>h.name===habitName); if(!habit) return 0;
      while(true){ const key = formatDateKey(d); if(!isHabitActiveOn(habit, key)) break; const done = data.completions[key] && data.completions[key][habitName]; if(done){ streak++; d.setDate(d.getDate()-1); } else break; }
      return streak;
    }

    function computeBestStreakCached(habitName){
      if(caches.bestStreak.has(habitName)) return caches.bestStreak.get(habitName);
      const habit = data.habits.find(h=>h.name===habitName); if(!habit) return 0;
      const start = parseDateKey(habit.startDate); const keys = Object.keys(data.completions).sort(); if(keys.length===0){ caches.bestStreak.set(habitName,0); return 0; }
      const firstKey = parseDateKey(keys[0]); const lastKey = parseDateKey(keys[keys.length-1]); const from = start < firstKey ? start : firstKey; const to = lastKey;
      let best = 0; let d = new Date(from);
      while(d <= to){ const key = formatDateKey(d); if(isHabitActiveOn(habit, key) && data.completions[key] && data.completions[key][habitName]){ let count = 0; let dd = new Date(d); while(true){ const kk = formatDateKey(dd); if(isHabitActiveOn(habit, kk) && data.completions[kk] && data.completions[kk][habitName]){ count++; dd.setDate(dd.getDate()+1); } else break; } if(count>best) best=count; d.setDate(d.getDate()+count); } else { d.setDate(d.getDate()+1); } }
      caches.bestStreak.set(habitName,best); return best;
    }

    function monthRateCached(h, year, month){ const key=`${h.name}|${year}-${month}`; if(caches.monthRate.has(key)) return caches.monthRate.get(key); const r = monthRate(h, year, month); caches.monthRate.set(key,r); return r; }
    function monthRate(h, year, month){ const daysInMonth = new Date(year, month+1, 0).getDate(); let activeDays = 0, doneDays = 0; for(let d=1; d<=daysInMonth; d++){ const dk = formatDateKey(new Date(year, month, d)); if(isHabitActiveOn(h, dk)){ activeDays++; if(data.completions[dk] && data.completions[dk][h.name]) doneDays++; } } return activeDays===0 ? 0 : doneDays/activeDays; }
    function habitAllTimeMonthlyMaxCached(h){ if(caches.monthlyMax.has(h.name)) return caches.monthlyMax.get(h.name); let max=0; for(let y=minYear;y<=maxYear;y++){ for(let m=0;m<12;m++){ const r=monthRateCached(h,y,m); if(r>max) max=r; } } caches.monthlyMax.set(h.name,max); return max; }

    function ensureYearRendered(y){ if(document.getElementById('year-'+y)) return; const el = document.createElement('section'); el.id='year-'+y; el.className='year-block rounded-xl p-4'; const title=document.createElement('h2'); title.className='text-3xl font-extrabold mb-3 hover:underline cursor-pointer'; title.textContent=y; title.dataset.year=y; title.onclick=()=>openYearModal(y); el.appendChild(title); const grid=document.createElement('div'); grid.className='grid month-grid gap-4'; for(let m=0;m<12;m++){ const month=document.createElement('div'); month.className='p-3 rounded-lg bg-white/5'; const mtitle=document.createElement('button'); mtitle.type='button'; mtitle.className='font-semibold mb-2 text-sm hover:underline cursor-pointer'; mtitle.textContent=monthNameShort(m); mtitle.dataset.year=y; mtitle.dataset.month=m; mtitle.onclick=()=>openMonthModal(y,m); month.appendChild(mtitle); const days=document.createElement('div'); days.className='grid grid-cols-7 gap-1 text-xs text-white/80'; const first=new Date(y,m,1); const total=new Date(y,m+1,0).getDate(); const offset=first.getDay(); for(let i=0;i<offset;i++){ days.appendChild(Object.assign(document.createElement('div'),{className:'text-white/10',innerHTML:'\u00A0'})); } for(let d=1; d<=total; d++){ const date=new Date(y,m,d); const dk=formatDateKey(date); const btn=document.createElement('button'); btn.className='day-cell text-[11px]'; btn.textContent=d; btn.dataset.dateKey=dk; applyDayCellStyle(btn, dk); if(dk===formatDateKey(new Date())) btn.classList.add('ring-2','ring-white/10'); btn.onclick=()=>openDayPanel(dk); days.appendChild(btn);} month.appendChild(days); grid.appendChild(month);} el.appendChild(grid); yearsContainer.appendChild(el); }

    function applyDayCellStyle(btn, dk){
      const actives = data.habits.filter(h=>isHabitActiveOn(h,dk));
      const allGold = actives.length>0 && actives.every(h=>{ const cur=computeStreakForHabit(h.name, dk); const best=Math.max(h.bestStreak||0, computeBestStreakCached(h.name)); const doneToday=!!(data.completions[dk] && data.completions[dk][h.name]); return doneToday && cur>=best; });
      if(allGold){
        btn.style.background='linear-gradient(135deg, var(--gold), var(--gold-deep))';
        btn.classList.add('gold');
        btn.style.color = '#0a0a0a';
      } else {
        const rate=getCompletionRate(dk);
        btn.classList.remove('gold');
        btn.style.background='';
        btn.style.backgroundColor=`rgba(0,255,100,${rate})`;
        btn.style.color = rate>0 ? '#0a0a0a' : '';
      }
    }

    function updateDayCell(dk){ const el = document.querySelector(`button.day-cell[data-date-key="${dk}"]`); if(el) applyDayCellStyle(el, dk); }

    function renderYears(){ yearsContainer.innerHTML=''; for(let y=minYear;y<=maxYear;y++) ensureYearRendered(y); }

    const focusCurrentMonth = ()=>{
      const yEl=document.getElementById('year-'+currentYear);
      if(!yEl) return;
      const monthBtn=yEl.querySelector(`button.font-semibold[data-year="${currentYear}"][data-month="${currentMonth}"]`);
      if(monthBtn){ requestAnimationFrame(()=>{ monthBtn.scrollIntoView({block:'center', behavior:'smooth'}); }); }
      else { yEl.scrollIntoView({block:'center', behavior:'smooth'}); }
    };

    // === OUVERTURE / FERMETURE DU PANNEAU DAY ===
    function openDayPanel(dateKey){
      focusedDateKey=dateKey;
      panelDate.textContent=new Date(dateKey).toLocaleDateString('fr-FR',{weekday:'short', day:'numeric', month:'short', year:'numeric'});
      panelDateLong.textContent=dateKey;
      populateHabits(dateKey, habitsList, false);
      dayPanel.classList.remove('hidden');
      dayOverlay.classList.remove('hidden');
      requestAnimationFrame(()=>{ dayPanel.style.transform='translateX(0)'; });
    }
    function closeDayPanel(){
      dayPanel.style.transform='translateX(110%)';
      dayOverlay.classList.add('hidden');
      // petite temporisation pour permettre l'anim avant de cacher complètement
      setTimeout(()=>{ if(dayPanel.style.transform.includes('110%')) dayPanel.classList.add('hidden'); }, 250);
    }

    // bouton (masqué) + overlay + touche Echap
    document.getElementById('closePanel').onclick=closeDayPanel;
    dayOverlay.addEventListener('click', closeDayPanel);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeDayPanel(); });

    const makeStreakBadge=(cur,best,isBestNow)=>{ const span=document.createElement('span'); span.className='streak-badge'+(isBestNow && cur>0 ? ' streak-badge--best':'' ); span.textContent=`${cur} / ${best}`; span.title='Série actuelle / meilleur record'; return span; };

    let persistTimer=null; const persistDebounced=(delay=250)=> new Promise(res=>{ clearTimeout(persistTimer); persistTimer=setTimeout(async()=>{ try{ data._rev=(data._rev||0)+1; lastLocalRev=data._rev; await setDoc(docRef, data); } finally { res(); } }, delay); });

    function makeHabitToggleButton(h, dateKey, onChanged, opts = {}) {
      const { isDayView = false } = opts;
      const done = !!(data.completions[dateKey] && data.completions[dateKey][h.name]);
      const width = isDayView ? ['w-4/5'] : ['w-auto'];
      const textSize = isDayView ? 'text-xl' : 'text-xs';
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.setAttribute('aria-pressed', done ? 'true' : 'false');
      btn.className = [ ...width,'px-4','py-3','rounded-xl','border','transition', textSize,'font-semibold', done ? 'bg-[rgb(0,200,75)] border-green-400/40 ring-1 ring-green-300/30 text-black' : 'bg-white/5 border-white/10 hover:bg-white/10 text-white' ].join(' ');
      btn.textContent = h.name;
      btn.onclick = async () => {
        if (!data.completions[dateKey]) data.completions[dateKey] = {};
        data.completions[dateKey][h.name] = !done;
        const d = new Date(dateKey);
        clearMonthCacheForHabit(h.name, d.getFullYear(), d.getMonth());
        clearHabitCaches(h.name);
        if (typeof onChanged === 'function') onChanged();
        updateDayCell(dateKey);
        await persistDebounced();
      };
      return btn;
    }

    function populateHabits(dateKey, container, minimal=false){
      container.innerHTML=''; const actives=data.habits.filter(h=>isHabitActiveOn(h,dateKey)); if(actives.length===0){ container.innerHTML='<div class="text-sm text-white/60">Aucune habitude active.</div>'; return; }
      const rerenderSelf = ()=> populateHabits(dateKey, container, minimal);
      const isDayContainer = container && container.id === 'habitsList' ? false : (container && container.id === 'dayHabitsList');
      if(minimal || isSmall()){
        actives.forEach(h=>{ const row=document.createElement('div'); row.className='w-full flex justify-center'; row.appendChild(makeHabitToggleButton(h, dateKey, rerenderSelf, { isDayView: isDayContainer })); container.appendChild(row); }); return; }
      actives.forEach(h=>{ const row=document.createElement('div'); row.className='flex items-center justify-between gap-2'; const left=document.createElement('div'); left.className='flex items-center gap-3'; const toggleBtn=makeHabitToggleButton(h, dateKey, rerenderSelf, { isDayView: isDayContainer }); left.append(toggleBtn); row.append(left); const right=document.createElement('div'); right.className='flex items-center gap-2'; const curLabel=computeStreakForHabit(h.name, dateKey); const bestLabel=Math.max(h.bestStreak||0, computeBestStreakCached(h.name)); const badge=makeStreakBadge(curLabel, bestLabel, curLabel>=bestLabel); const edit=document.createElement('button'); edit.className='text-xs px-2 py-1 rounded hover:bg白/5'; edit.textContent='✏️'; edit.onclick=async()=>{ const newName=prompt('Nouveau nom pour '+h.name,h.name); if(newName&&newName.trim()!==h.name){ const oldName=h.name; h.name=newName.trim(); for(const k in data.completions){ if(data.completions[k] && Object.prototype.hasOwnProperty.call(data.completions[k], oldName)){ data.completions[k][h.name]=data.completions[k][oldName]; delete data.completions[k][oldName]; } } clearHabitCaches(oldName); clearHabitCaches(h.name); await persistDebounced(0); rerenderSelf(); } }; const del=document.createElement('button'); del.className='text-xs px-2 py-1 rounded hover:bg-white/5'; del.textContent='🗑️'; del.onclick=async()=>{ h.deletedAt=new Date().toISOString().slice(0,10); clearHabitCaches(h.name); await persistDebounced(0); rerenderSelf(); updateDayCell(dateKey); }; right.append(badge,edit,del); row.append(right); container.append(row); });
    }

    function showDayPage(dateKey){
      homePage.classList.add('hidden'); dayPage.classList.remove('hidden');
      const d=parseDateKey(dateKey);
      const month = d.toLocaleDateString('fr-FR', { month: 'long'});
      const rest = d.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric' });
      dayTitle.innerHTML = `${month}<br>${rest}`;
      dayTitleSub.textContent=dateKey;
      // Liste au bas de la page (80% + texte XL uniquement pour la vue Day)
      dayHabitsList.className='mb-16 space-y-3 flex flex-col items-center sm:pb-0';
      populateHabits(dateKey, dayHabitsList, true);
      focusedDateKey=dateKey;
      document.getElementById('prevDay').onclick=()=>{ const p=new Date(d); p.setDate(p.getDate()-1); showDayPage(formatDateKey(p)); };
      document.getElementById('nextDay').onclick=()=>{ const n=new Date(d); n.setDate(n.getDate()+1); showDayPage(formatDateKey(n)); };
      document.getElementById('todayBtn').onclick=()=>{ const t=new Date(); showDayPage(formatDateKey(t)); };
      window.location.hash = `#/day/${dateKey}`;
    }

    appTitle.onclick = ()=>{ const hash=window.location.hash||''; if(hash.startsWith('#/day')){ goHome(); } else { showDayPage(focusedDateKey || formatDateKey(new Date())); } };

    function openMonthModal(year, month){ monthSummary.innerHTML=''; monthModal.classList.remove('hidden'); monthModal.classList.add('flex'); monthModalTitle.textContent = `${monthNameLong(month)} ${year}`; /* … (inchangé) … */ }
    document.getElementById('closeMonth').onclick=()=>{ monthModal.classList.add('hidden'); monthModal.classList.remove('flex'); };

    function openYearModal(year){ yearSummary.innerHTML=''; yearModal.classList.remove('hidden'); yearModal.classList.add('flex'); yearModalTitle.textContent = `${year}`; /* … (inchangé) … */ }
    document.getElementById('closeYear').onclick=()=>{ yearModal.classList.add('hidden'); yearModal.classList.remove('flex'); };

    function goHome(){ homePage.classList.remove('hidden'); dayPage.classList.add('hidden'); window.location.hash='#/home'; focusCurrentMonth(); }

    const modalAddHabit=document.getElementById('modalAddHabit');
    document.getElementById('addHabitBtn').onclick=()=>{ document.getElementById('habitNameInput').value=''; document.getElementById('habitStartInput').value=new Date().toISOString().slice(0,10); modalAddHabit.classList.remove('hidden'); modalAddHabit.classList.add('flex'); };
    document.getElementById('cancelAddHabit').onclick=()=>{ modalAddHabit.classList.add('hidden'); modalAddHabit.classList.remove('flex'); };
    document.getElementById('confirmAddHabit').onclick=async()=>{ const name=document.getElementById('habitNameInput').value.trim(); const start=document.getElementById('habitStartInput').value; if(!name||!start){ alert('Nom et date requis'); return; } data.habits.push({name,startDate:start}); clearHabitCaches(name); await persistDebounced(0); modalAddHabit.classList.add('hidden'); modalAddHabit.classList.remove('flex'); renderYears(); };

    document.getElementById('exportBtn').onclick=()=>{ const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='fourpill-data.json'; a.click(); URL.revokeObjectURL(url); };
    document.getElementById('importBtn').onclick=()=>document.getElementById('fileInput').click();
    document.getElementById('fileInput').onchange=async e=>{ const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=async()=>{ data=JSON.parse(r.result); clearAllCaches(); await persistDebounced(0); renderYears(); focusCurrentMonth(); }; r.readAsText(f); };

    function router(){ const [,route,a]=(window.location.hash||'').split('/'); if(isSmall()){ const today=formatDateKey(new Date()); if(route==='day' && a){ showDayPage(a);} else { showDayPage(today);} } else { if(route==='day' && a){ showDayPage(a);} else { goHome(); } } }
    window.addEventListener('hashchange', router); window.addEventListener('resize', router);

    // Click-outside générique pour les modals (déjà présent, conservé si besoin)
    function bindOverlayClose(overlayEl, closeFn){ if(!overlayEl) return; overlayEl.addEventListener('click', (e)=>{ if(e.target === overlayEl) closeFn(); }); }
    bindOverlayClose(modalAddHabit, ()=>{ modalAddHabit.classList.add('hidden'); modalAddHabit.classList.remove('flex'); });
    bindOverlayClose(monthModal, ()=>{ monthModal.classList.add('hidden'); monthModal.classList.remove('flex'); });
    bindOverlayClose(yearModal, ()=>{ yearModal.classList.add('hidden'); yearModal.classList.remove('flex'); });

    // Firestore
    let app, db, docRef, unsub;
    async function initFirestore(){ app = initializeApp(firebaseConfig); db=getFirestore(app); try{ await enableIndexedDbPersistence(db);}catch(e){} docRef=doc(db,'single','fourpill'); unsub=onSnapshot(docRef,(snap)=>{
        if(snap.exists()){
          const server=snap.data();
          if(server._rev && server._rev===lastLocalRev){ return; }
          data = server; clearAllCaches();
        } else {
          data={habits:[],completions:{}, _rev:0}; setDoc(docRef,data).catch(console.error);
        }
        if(!initialSynced){ renderYears(); router(); focusCurrentMonth(); initialSynced=true; } else { if(focusedDateKey) updateDayCell(focusedDateKey); }
      }, (err)=>{ console.error('onSnapshot error',err); }); }

    (async function initApp(){ await initFirestore(); })();
  </script>
</body>
</html>
