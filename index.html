<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Fourpill ‚Äî Accueil</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --gold:#FFD700; --gold-deep:#C9A227; --bg:#0b0c10; --panel:#0f1720; --text:#e6eef8; }
    body { background: var(--bg); color: var(--text); }
    .month-grid { grid-template-columns: repeat(3, minmax(0,1fr)); }
    .day-cell { width: 1.6rem; height: 1.6rem; display:flex;align-items:center;justify-content:center;border-radius:.35rem; transition: background-color 0.2s, transform .12s; }
    .day-cell:hover { transform: translateY(-2px); }
    .gold { box-shadow: 0 0 16px rgba(255,215,0,0.35), inset 0 0 0 1px rgba(255,215,0,0.45); border: 1px solid rgba(255,215,0,0.55); }
    .gold-bg { background: linear-gradient(135deg, var(--gold), var(--gold-deep)); padding: .12rem .5rem; border-radius: .45rem; color: #0a0a0a; font-weight:700; box-shadow: 0 0 18px rgba(255,215,0,.28); }
    .gold-chip { background: linear-gradient(135deg, var(--gold), var(--gold-deep)); color:#0a0a0a; font-weight:700; border:1px solid rgba(255,215,0,.55); box-shadow: 0 0 18px rgba(255,215,0,.28); }
    .streak-badge{ padding:.12rem .45rem; border-radius:.45rem; font-weight:600; font-size:.8rem; border:1px solid rgba(255,255,255,.18); color: rgba(255,255,255,.9); }
    .streak-badge--best{ background: linear-gradient(135deg, var(--gold), var(--gold-deep)); color:#0a0a0a; border-color: rgba(255,215,0,.55); box-shadow: 0 0 18px rgba(255,215,0,.28); }
    .bar { width: 100%; border-radius: 3px 3px 0 0; background: linear-gradient(180deg, var(--gold), var(--gold-deep)); }
    .bar-muted { background: rgba(255,255,255,.15); }
    .chip { font-size:.75rem; padding:.2rem .5rem; border-radius:.4rem; border:1px solid rgba(255,255,255,.15); display:inline-flex; align-items:center; gap:.3rem; }
    .chip-neutral{ background: rgba(255,255,255,.06); color:#e6eef8; }
    .chip-up{ background: rgba(34,197,94,.15); color:#d1fae5; }
    .chip-down{ background: rgba(239,68,68,.15); color:#fee2e2; }
    ::-webkit-scrollbar{width:8px;height:8px}
    ::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.06);border-radius:8px}
  </style>
</head>
<body class="antialiased min-h-screen">
  <header class="fixed top-0 left-0 right-0 z-40 backdrop-blur-md bg-gradient-to-b from-black/40 to-transparent border-b border-white/5">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2 sm:gap-4">
        <button id="appTitle" class="text-sm sm:text-base font-extrabold tracking-wide hover:opacity-80">Fourpill</button>
      </div>
      <div class="flex items-center gap-3">
        <button id="importBtn" class="text-sm px-3 py-1 rounded hover:bg-white/5">Importer</button>
        <button id="exportBtn" class="text-sm px-3 py-1 rounded hover:bg-white/5">Exporter</button>
        <button id="addHabitBtn" class="text-sm bg-white/10 px-3 py-1 rounded hover:bg-white/15">+ Habitude</button>
      </div>
    </div>
  </header>

  <!-- hauteur forc√©e retir√©e pour √©viter une barre opaque bloquante -->
  <main id="homePage" class="pt-20 pb-24 max-w-5xl mx-auto px-4 space-y-10 overflow-auto" style="scroll-behavior: smooth;"></main>

  <div id="dayPanel" class="hidden md:block fixed right-4 top-20 z-50 w-96 max-w-full bg-[var(--panel)] border border-white/10 rounded-2xl shadow-2xl p-4 transform translate-x-full transition-transform duration-300">
    <div class="flex items-start justify-between mb-3">
      <div>
        <div id="panelDate" class="text-sm font-semibold">Jour</div>
        <div id="panelDateLong" class="text-xs text-white/60">date</div>
      </div>
      <button id="closePanel" class="text-sm px-2 py-1 rounded hover:bg-white/5">Fermer</button>
    </div>
    <div id="habitsList" class="space-y-3 max-h-72 overflow-auto pb-2"></div>
  </div>

  <!-- DAY PAGE: boutons larges (80%) coll√©s en bas pour usage √† une main -->
  <section id="dayPage" class="hidden pt-20 pb-28 max-w-2xl mx-auto px-4 min-h-screen flex flex-col">
    <div class="grid grid-cols-3 items-center mb-4">
      <div class="flex justify-start"><button id="prevDay" class="px-3 py-1 rounded hover:bg-white/5">‚óÄ</button></div>
      <div class="text-center">
        <div id="dayTitle" class="text-lg font-extrabold"></div>
        <div id="dayTitleSub" class="text-xs text-white/60"></div>
      </div>
      <div class="flex items-center justify-end gap-2">
        <button id="todayBtn" class="px-3 py-1 rounded hover:bg-white/5" title="Aller au jour actuel">üéØ</button>
        <button id="nextDay" class="px-3 py-1 rounded hover:bg-white/5">‚ñ∂</button>
      </div>
    </div>
    <!-- La liste est pouss√©e en bas gr√¢ce √† mt-auto -->
    <div id="dayHabitsList" class="mt-auto mb-6 space-y-3 flex flex-col items-center"></div>
  </section>

  <!-- Modal: Add Habit -->
  <div id="modalAddHabit" class="fixed inset-0 z-60 hidden items-center justify-center bg-black/50" role="dialog" aria-modal="true">
    <div class="bg-[#0b1220] border border-white/10 rounded-xl p-4 w-96 shadow-2xl">
      <h3 class="font-semibold mb-2">Ajouter une habitude</h3>
      <input id="habitNameInput" class="w-full p-2 rounded bg-white/5 mb-2" placeholder="Nom de l'habite" />
      <label class="block text-xs text-white/60 mb-2">Active √† partir de :</label>
      <input id="habitStartInput" type="date" class="w-full p-2 rounded bg-white/5 mb-3" />
      <div class="flex justify-end gap-2">
        <button id="cancelAddHabit" class="px-3 py-1 rounded hover:bg-white/5">Annuler</button>
        <button id="confirmAddHabit" class="px-3 py-1 bg-white/10 rounded hover:bg-white/15">Ajouter</button>
      </div>
    </div>
  </div>

  <!-- Month Modal -->
  <div id="modalMonth" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 p-4">
    <div class="bg-[var(--panel)] border border-white/10 rounded-2xl p-4 w-full max-w-2xl max-h-[85vh] overflow-auto">
      <div class="flex items-center justify-between mb-2">
        <div class="font-bold" id="monthModalTitle">Mois</div>
        <button id="closeMonth" class="px-2 py-1 rounded hover:bg-white/5">Fermer</button>
      </div>
      <p class="text-xs text-white/60 mb-3">Taux de compl√©tion du mois s√©lectionn√© et des <span class="font-semibold">2 mois pr√©c√©dents</span> (affich√©s s√©par√©ment). Le mois courant est <span class="font-semibold">dor√© uniquement</span> s'il s'agit du meilleur taux de tous les temps pour cette habitude.</p>
      <div id="monthSummary" class="space-y-2"></div>
    </div>
  </div>

  <!-- Year Modal -->
  <div id="modalYear" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 p-4">
    <div class="bg-[var(--panel)] border border-white/10 rounded-2xl p-4 w-full max-w-3xl max-height-[85vh] overflow-auto">
      <div class="flex items-center justify-between mb-2">
        <div class="font-bold" id="yearModalTitle">Ann√©e</div>
        <button id="closeYear" class="px-2 py-1 rounded hover:bg-white/5">Fermer</button>
      </div>
      <p class="text-xs text-white/60 mb-3">Taux de compl√©tion <span class="font-semibold">mensuel</span> pour chaque habitude sur l'ann√©e.</p>
      <div id="yearSummary" class="space-y-3"></div>
    </div>
  </div>

  <input id="fileInput" type="file" accept="application/json" class="hidden" />

  <script type="module">
    // ===== Firebase (Firestore) =====
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
    import { getFirestore, doc, onSnapshot, setDoc, enableIndexedDbPersistence } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

    const firebaseConfig = { apiKey: "AIzaSyBptpMFEMc7ikXM0PtDOeWUHnMegKQ6hcs", authDomain: "habit-8d57f.firebaseapp.com", projectId: "habit-8d57f", storageBucket: "habit-8d57f.appspot.com", messagingSenderId: "934416417831", appId: "1:934416417831:web:63f2f0554daa6d3ff23a02" };

    // ===== State =====
    let data = { habits: [], completions: {}, _rev: 0 };
    let lastLocalRev = 0; let initialSynced = false;

    // Simple caches
    const caches = {
      bestStreak: new Map(),
      monthRate: new Map(),
      monthlyMax: new Map()
    };
    const clearAllCaches = ()=>{ caches.bestStreak.clear(); caches.monthRate.clear(); caches.monthlyMax.clear(); };
    const clearHabitCaches = (habitName)=>{ caches.bestStreak.delete(habitName); caches.monthlyMax.delete(habitName); for(const k of caches.monthRate.keys()){ if(k.startsWith(habitName+'|')) caches.monthRate.delete(k); } };
    const clearMonthCacheForHabit = (habitName, y, m)=>{ caches.monthRate.delete(`${habitName}|${y}-${m}`); caches.monthlyMax.delete(habitName); };

    // ===== Elements =====
    const homePage = document.getElementById('homePage');
    const yearsContainer = homePage; const dayPanel = document.getElementById('dayPanel');
    const panelDate = document.getElementById('panelDate'); const panelDateLong = document.getElementById('panelDateLong'); const habitsList = document.getElementById('habitsList');
    const dayPage = document.getElementById('dayPage'); const dayTitle = document.getElementById('dayTitle'); const dayTitleSub = document.getElementById('dayTitleSub'); const dayHabitsList = document.getElementById('dayHabitsList');
    const monthModal = document.getElementById('modalMonth'); const monthSummary = document.getElementById('monthSummary'); const monthModalTitle = document.getElementById('monthModalTitle');
    const yearModal = document.getElementById('modalYear'); const yearSummary = document.getElementById('yearSummary'); const yearModalTitle = document.getElementById('yearModalTitle');
    const appTitle = document.getElementById('appTitle');

    // ===== Helpers =====
    let focusedDateKey = null;
    const now = new Date(); const currentYear = now.getFullYear(); const currentMonth = now.getMonth();
    let minYear = 2025; let maxYear = currentYear + 5; const isSmall = () => window.matchMedia('(max-width: 639px)').matches;

    const formatDateKey = (d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const parseDateKey = (s)=> new Date(s+'T00:00:00');
    const monthNameShort = (m)=> ['Jan','F√©v','Mar','Avr','Mai','Jun','Jul','Ao√ª','Sep','Oct','Nov','D√©c'][m];
    const monthNameLong = (m)=> ['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'][m];

    const isHabitActiveOn = (h, dateKey)=>{ const d = parseDateKey(dateKey); const start = new Date(h.startDate+'T00:00:00'); if(d < start) return false; if(h.deletedAt && d >= new Date(h.deletedAt+'T00:00:00')) return false; return true; };

    const getCompletionRate = (dateKey)=>{ const dayData = data.completions[dateKey] || {}; const activeHabits = data.habits.filter(h=>isHabitActiveOn(h,dateKey)); if(activeHabits.length===0) return 0; const completed = activeHabits.filter(h=>dayData[h.name]).length; return completed / activeHabits.length; };

    function computeStreakForHabit(habitName, asOfDateKey){
      let d = parseDateKey(asOfDateKey); let streak = 0; const habit = data.habits.find(h=>h.name===habitName); if(!habit) return 0;
      while(true){ const key = formatDateKey(d); if(!isHabitActiveOn(habit, key)) break; const done = data.completions[key] && data.completions[key][habitName]; if(done){ streak++; d.setDate(d.getDate()-1); } else break; }
      return streak;
    }

    function computeBestStreakCached(habitName){
      if(caches.bestStreak.has(habitName)) return caches.bestStreak.get(habitName);
      const habit = data.habits.find(h=>h.name===habitName); if(!habit) return 0;
      const start = parseDateKey(habit.startDate); const keys = Object.keys(data.completions).sort(); if(keys.length===0){ caches.bestStreak.set(habitName,0); return 0; }
      const firstKey = parseDateKey(keys[0]); const lastKey = parseDateKey(keys[keys.length-1]); const from = start < firstKey ? start : firstKey; const to = lastKey;
      let best = 0; let d = new Date(from);
      while(d <= to){ const key = formatDateKey(d); if(isHabitActiveOn(habit, key) && data.completions[key] && data.completions[key][habitName]){ let count = 0; let dd = new Date(d); while(true){ const kk = formatDateKey(dd); if(isHabitActiveOn(habit, kk) && data.completions[kk] && data.completions[kk][habitName]){ count++; dd.setDate(dd.getDate()+1); } else break; } if(count>best) best=count; d.setDate(d.getDate()+count); } else { d.setDate(d.getDate()+1); } }
      caches.bestStreak.set(habitName,best); return best;
    }

    function monthRateCached(h, year, month){ const key=`${h.name}|${year}-${month}`; if(caches.monthRate.has(key)) return caches.monthRate.get(key); const r = monthRate(h, year, month); caches.monthRate.set(key,r); return r; }
    function monthRate(h, year, month){ const daysInMonth = new Date(year, month+1, 0).getDate(); let activeDays = 0, doneDays = 0; for(let d=1; d<=daysInMonth; d++){ const dk = formatDateKey(new Date(year, month, d)); if(isHabitActiveOn(h, dk)){ activeDays++; if(data.completions[dk] && data.completions[dk][h.name]) doneDays++; } } return activeDays===0 ? 0 : doneDays/activeDays; }
    function habitAllTimeMonthlyMaxCached(h){ if(caches.monthlyMax.has(h.name)) return caches.monthlyMax.get(h.name); let max=0; for(let y=minYear;y<=maxYear;y++){ for(let m=0;m<12;m++){ const r=monthRateCached(h,y,m); if(r>max) max=r; } } caches.monthlyMax.set(h.name,max); return max; }

    function ensureYearRendered(y){ if(document.getElementById('year-'+y)) return; const el = document.createElement('section'); el.id='year-'+y; el.className='year-block rounded-xl p-4'; const title=document.createElement('h2'); title.className='text-3xl font-extrabold mb-3 hover:underline cursor-pointer'; title.textContent=y; title.dataset.year=y; title.onclick=()=>openYearModal(y); el.appendChild(title); const grid=document.createElement('div'); grid.className='grid month-grid gap-4'; for(let m=0;m<12;m++){ const month=document.createElement('div'); month.className='p-3 rounded-lg bg-white/5'; const mtitle=document.createElement('button'); mtitle.type='button'; mtitle.className='font-semibold mb-2 text-sm hover:underline cursor-pointer'; mtitle.textContent=monthNameShort(m); mtitle.dataset.year=y; mtitle.dataset.month=m; mtitle.onclick=()=>openMonthModal(y,m); month.appendChild(mtitle); const days=document.createElement('div'); days.className='grid grid-cols-7 gap-1 text-xs text-white/80'; const first=new Date(y,m,1); const total=new Date(y,m+1,0).getDate(); const offset=first.getDay(); for(let i=0;i<offset;i++){ days.appendChild(Object.assign(document.createElement('div'),{className:'text-white/10',innerHTML:'\u00A0'})); } for(let d=1; d<=total; d++){ const date=new Date(y,m,d); const dk=formatDateKey(date); const btn=document.createElement('button'); btn.className='day-cell text-[11px]'; btn.textContent=d; btn.dataset.dateKey=dk; applyDayCellStyle(btn, dk); if(dk===formatDateKey(new Date())) btn.classList.add('ring-2','ring-white/10'); btn.onclick=()=>openDayPanel(dk); days.appendChild(btn);} month.appendChild(days); grid.appendChild(month);} el.appendChild(grid); yearsContainer.appendChild(el); }

    function applyDayCellStyle(btn, dk){
      const actives = data.habits.filter(h=>isHabitActiveOn(h,dk));
      const allGold = actives.length>0 && actives.every(h=>{ const cur=computeStreakForHabit(h.name, dk); const best=Math.max(h.bestStreak||0, computeBestStreakCached(h.name)); const doneToday=!!(data.completions[dk] && data.completions[dk][h.name]); return doneToday && cur>=best; });
      if(allGold){
        btn.style.background='linear-gradient(135deg, var(--gold), var(--gold-deep))';
        btn.classList.add('gold');
        btn.style.color = '#0a0a0a';
      } else {
        const rate=getCompletionRate(dk);
        btn.classList.remove('gold');
        btn.style.background='';
        btn.style.backgroundColor=`rgba(0,255,100,${rate})`;
        // ‚úÖ texte noir d√®s qu'il y a du vert, quelle que soit l'opacit√©
        btn.style.color = rate>0 ? '#0a0a0a' : '';
      }
    }

    function updateDayCell(dk){ const el = document.querySelector(`button.day-cell[data-date-key="${dk}"]`); if(el) applyDayCellStyle(el, dk); }

    function renderYears(){ yearsContainer.innerHTML=''; for(let y=minYear;y<=maxYear;y++) ensureYearRendered(y); }

    // üëâ centre le mois courant au chargement
    const focusCurrentMonth = ()=>{
      const yEl=document.getElementById('year-'+currentYear);
      if(!yEl) return;
      const monthBtn=yEl.querySelector(`button.font-semibold[data-year="${currentYear}"][data-month="${currentMonth}"]`);
      if(monthBtn){
        requestAnimationFrame(()=>{
          monthBtn.scrollIntoView({block:'center', behavior:'smooth'});
        });
      } else {
        yEl.scrollIntoView({block:'center', behavior:'smooth'});
      }
    };

    function openDayPanel(dateKey){ focusedDateKey=dateKey; panelDate.textContent=new Date(dateKey).toLocaleDateString('fr-FR',{weekday:'short', day:'numeric', month:'short', year:'numeric'}); panelDateLong.textContent=dateKey; populateHabits(dateKey, habitsList, false); dayPanel.style.transform='translateX(0)'; }
    document.getElementById('closePanel').onclick=()=>dayPanel.style.transform='translateX(110%)';

    const makeStreakBadge=(cur,best,isBestNow)=>{ const span=document.createElement('span'); span.className='streak-badge'+(isBestNow && cur>0 ? ' streak-badge--best':'' ); span.textContent=`${cur} / ${best}`; span.title='S√©rie actuelle / meilleur record'; return span; };

    // === Persist + d√©-bouclage onSnapshot ===
    let persistTimer=null; const persistDebounced=(delay=250)=> new Promise(res=>{ clearTimeout(persistTimer); persistTimer=setTimeout(async()=>{ try{ data._rev=(data._rev||0)+1; lastLocalRev=data._rev; await setDoc(docRef, data); } finally { res(); } }, delay); });

    function makeHabitToggleButton(h, dateKey, onChanged){
      const done = !!(data.completions[dateKey] && data.completions[dateKey][h.name]);
      const btn = document.createElement('button'); btn.type='button'; btn.setAttribute('aria-pressed', done ? 'true' : 'false');
      btn.className=[
        // largeur 80% sur mobile, auto sur sm+
        'w-4/5','sm:w-auto',
        // style
        'px-4','py-3','rounded-xl','border','transition','text-sm','font-semibold',
        done ? 'bg-blue-500/30 border-blue-400/40 ring-1 ring-blue-300/30' : 'bg-white/5 border-white/10 hover:bg-white/10'
      ].join(' ');
      btn.textContent=h.name;
      btn.onclick = async ()=>{
        if(!data.completions[dateKey]) data.completions[dateKey] = {}; data.completions[dateKey][h.name] = !done;
        const d=new Date(dateKey); clearMonthCacheForHabit(h.name, d.getFullYear(), d.getMonth()); clearHabitCaches(h.name);
        if(typeof onChanged==='function') onChanged(); updateDayCell(dateKey);
        await persistDebounced();
      };
      return btn;
    }

    function populateHabits(dateKey, container, minimal=false){
      container.innerHTML=''; const actives=data.habits.filter(h=>isHabitActiveOn(h,dateKey)); if(actives.length===0){ container.innerHTML='<div class="text-sm text-white/60">Aucune habitude active.</div>'; return; }

      const rerenderSelf = ()=> populateHabits(dateKey, container, minimal);

      if(minimal || isSmall()){
        actives.forEach(h=>{ const row=document.createElement('div'); row.className='w-full flex justify-center'; row.appendChild(makeHabitToggleButton(h, dateKey, rerenderSelf)); container.appendChild(row); }); return; }

      actives.forEach(h=>{ const row=document.createElement('div'); row.className='flex items-center justify-between gap-2'; const left=document.createElement('div'); left.className='flex items-center gap-3'; const toggleBtn=makeHabitToggleButton(h, dateKey, rerenderSelf); left.append(toggleBtn); row.append(left); const right=document.createElement('div'); right.className='flex items-center gap-2'; const curLabel=computeStreakForHabit(h.name, dateKey); const bestLabel=Math.max(h.bestStreak||0, computeBestStreakCached(h.name)); const badge=makeStreakBadge(curLabel, bestLabel, curLabel>=bestLabel); const edit=document.createElement('button'); edit.className='text-xs px-2 py-1 rounded hover:bg-white/5'; edit.textContent='‚úèÔ∏è'; edit.onclick=async()=>{ const newName=prompt('Nouveau nom pour '+h.name,h.name); if(newName&&newName.trim()!==h.name){ const oldName=h.name; h.name=newName.trim(); for(const k in data.completions){ if(data.completions[k] && Object.prototype.hasOwnProperty.call(data.completions[k], oldName)){ data.completions[k][h.name]=data.completions[k][oldName]; delete data.completions[k][oldName]; } } clearHabitCaches(oldName); clearHabitCaches(h.name); await persistDebounced(0); rerenderSelf(); } }; const del=document.createElement('button'); del.className='text-xs px-2 py-1 rounded hover:bg-white/5'; del.textContent='üóëÔ∏è'; del.onclick=async()=>{ h.deletedAt=new Date().toISOString().slice(0,10); clearHabitCaches(h.name); await persistDebounced(0); rerenderSelf(); updateDayCell(dateKey); }; right.append(badge,edit,del); row.append(right); container.append(row); });
    }

    function showDayPage(dateKey){
      homePage.classList.add('hidden'); dayPage.classList.remove('hidden');
      const d=parseDateKey(dateKey);
      dayTitle.textContent=d.toLocaleDateString('fr-FR',{weekday:'long', day:'numeric', month:'long'});
      dayTitleSub.textContent=dateKey;
      // Liste au bas de la page pour usage √† une main
      dayHabitsList.className='mt-auto mb-6 space-y-3 flex flex-col items-center';
      populateHabits(dateKey, dayHabitsList, true);
      focusedDateKey=dateKey;
      document.getElementById('prevDay').onclick=()=>{ const p=new Date(d); p.setDate(p.getDate()-1); showDayPage(formatDateKey(p)); };
      document.getElementById('nextDay').onclick=()=>{ const n=new Date(d); n.setDate(n.getDate()+1); showDayPage(formatDateKey(n)); };
      document.getElementById('todayBtn').onclick=()=>{ const t=new Date(); showDayPage(formatDateKey(t)); };
      window.location.hash = `#/day/${dateKey}`;
    }

    // Toggling Home <-> Day via "Fourpill"
    appTitle.onclick = ()=>{ const hash=window.location.hash||''; if(hash.startsWith('#/day')){ goHome(); } else { showDayPage(focusedDateKey || formatDateKey(new Date())); } };

    function openMonthModal(year, month){ monthSummary.innerHTML=''; monthModal.classList.remove('hidden'); monthModal.classList.add('flex'); monthModalTitle.textContent = `${monthNameLong(month)} ${year}`; const presentHabits=data.habits.filter(h=>{ const dim=new Date(year, month+1, 0).getDate(); for(let d=1; d<=dim; d++){ const dk=formatDateKey(new Date(year, month, d)); if(isHabitActiveOn(h, dk)) return true; } return false; }); const prev1Y=month===0?year-1:year; const prev1M=month===0?11:month-1; const prev2Y=(month===0? year-1 : (month===1? year-1 : year)); const prev2M=(month+10)%12; presentHabits.forEach(h=>{ const rNow=monthRateCached(h, year, month); const r1=monthRateCached(h, prev1Y, prev1M); const r2=monthRateCached(h, prev2Y, prev2M); const arrow1 = r1>rNow ? '‚ñº' : (r1<rNow ? '‚ñ≤' : '='); const cls1 = r1>rNow ? 'chip-down' : (r1<rNow ? 'chip-up' : 'chip-neutral'); const arrow2 = r2>rNow ? '‚ñº' : (r2<rNow ? '‚ñ≤' : '='); const cls2 = r2>rNow ? 'chip-down' : (r2<rNow ? 'chip-up' : 'chip-neutral'); const bestMax = habitAllTimeMonthlyMaxCached(h); const isATH = Math.round(rNow*1000) === Math.round(bestMax*1000) && bestMax>0; const nowClass = (isATH ? 'gold-chip' : 'chip-neutral'); const row=document.createElement('div'); row.className='flex items-center justify-between bg-white/5 rounded-lg px-3 py-2'; row.innerHTML=`<div class="font-medium">${h.name}</div>
          <div class="flex items-center gap-2 text-xs">
            <span class="chip ${nowClass}">${monthNameShort(month)}: ${Math.round(rNow*100)}%</span>
            <span class="chip ${cls1}">${arrow1} ${monthNameShort(prev1M)}: ${Math.round(r1*100)}%</span>
            <span class="chip ${cls2}">${arrow2} ${monthNameShort(prev2M)}: ${Math.round(r2*100)}%</span>`; monthSummary.appendChild(row); }); }
    document.getElementById('closeMonth').onclick=()=>{ monthModal.classList.add('hidden'); monthModal.classList.remove('flex'); };

    function openYearModal(year){ yearSummary.innerHTML=''; yearModal.classList.remove('hidden'); yearModal.classList.add('flex'); yearModalTitle.textContent = `${year}`; const habitsInYear=data.habits.filter(h=>{ for(let m=0;m<12;m++){ const dim=new Date(year, m+1, 0).getDate(); for(let d=1; d<=dim; d++){ const dk=formatDateKey(new Date(year, m, d)); if(isHabitActiveOn(h, dk)) return true; } } return false; }); habitsInYear.forEach(h=>{ const wrapper=document.createElement('div'); wrapper.className='bg-white/5 rounded-lg p-3'; const title=document.createElement('div'); title.className='font-semibold mb-2'; title.textContent=h.name; wrapper.appendChild(title); const bars=document.createElement('div'); bars.className='grid grid-cols-12 items-end gap-1 h-24'; for(let m=0;m<12;m++){ const rate=monthRateCached(h, year, m); const height=Math.round(rate*100); const bar=document.createElement('div'); bar.className='bar'; bar.style.height=Math.max(2,height)+'%'; bar.title=`${monthNameShort(m)}: ${Math.round(rate*100)}%`; if(height===0) bar.classList.add('bar-muted'); bars.appendChild(bar); } const legend=document.createElement('div'); legend.className='mt-2 text-[10px] text-white/60 grid grid-cols-12 gap-1'; for(let m=0;m<12;m++){ const l=document.createElement('div'); l.className='text-center'; l.textContent=monthNameShort(m)[0]; legend.appendChild(l);} wrapper.appendChild(bars); wrapper.appendChild(legend); yearSummary.appendChild(wrapper); }); }
    document.getElementById('closeYear').onclick=()=>{ yearModal.classList.add('hidden'); yearModal.classList.remove('flex'); };

    function goHome(){ homePage.classList.remove('hidden'); dayPage.classList.add('hidden'); window.location.hash='#/home'; focusCurrentMonth(); }

    const modalAddHabit=document.getElementById('modalAddHabit');
    document.getElementById('addHabitBtn').onclick=()=>{ document.getElementById('habitNameInput').value=''; document.getElementById('habitStartInput').value=new Date().toISOString().slice(0,10); modalAddHabit.classList.remove('hidden'); modalAddHabit.classList.add('flex'); };
    document.getElementById('cancelAddHabit').onclick=()=>{ modalAddHabit.classList.add('hidden'); modalAddHabit.classList.remove('flex'); };
    document.getElementById('confirmAddHabit').onclick=async()=>{ const name=document.getElementById('habitNameInput').value.trim(); const start=document.getElementById('habitStartInput').value; if(!name||!start){ alert('Nom et date requis'); return; } data.habits.push({name,startDate:start}); clearHabitCaches(name); await persistDebounced(0); modalAddHabit.classList.add('hidden'); modalAddHabit.classList.remove('flex'); renderYears(); };

    document.getElementById('exportBtn').onclick=()=>{ const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='fourpill-data.json'; a.click(); URL.revokeObjectURL(url); };
    document.getElementById('importBtn').onclick=()=>document.getElementById('fileInput').click();
    document.getElementById('fileInput').onchange=async e=>{ const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=async()=>{ data=JSON.parse(r.result); clearAllCaches(); await persistDebounced(0); renderYears(); focusCurrentMonth(); }; r.readAsText(f); };

    function router(){ const [,route,a]=(window.location.hash||'').split('/'); if(isSmall()){ const today=formatDateKey(new Date()); if(route==='day' && a){ showDayPage(a);} else { showDayPage(today);} } else { if(route==='day' && a){ showDayPage(a);} else { goHome(); } } }
    window.addEventListener('hashchange', router); window.addEventListener('resize', router);

    // ===== Firestore bootstrap =====
    let app, db, docRef, unsub;
    async function initFirestore(){ app = initializeApp(firebaseConfig); db=getFirestore(app); try{ await enableIndexedDbPersistence(db);}catch(e){} docRef=doc(db,'single','fourpill'); unsub=onSnapshot(docRef,(snap)=>{
        if(snap.exists()){
          const server=snap.data();
          if(server._rev && server._rev===lastLocalRev){ return; }
          data = server; clearAllCaches();
        } else {
          data={habits:[],completions:{}, _rev:0}; setDoc(docRef,data).catch(console.error);
        }
        if(!initialSynced){ renderYears(); router(); focusCurrentMonth(); initialSynced=true; } else { if(focusedDateKey) updateDayCell(focusedDateKey); }
      }, (err)=>{ console.error('onSnapshot error',err); }); }

    (async function initApp(){ await initFirestore(); })();

    // Dev sanity
    (function dev(){ try{ const tmpRate = monthRate({name:'_tmp', startDate: formatDateKey(new Date(currentYear,0,1))}, currentYear, 0); console.assert(typeof tmpRate==='number'); }catch(e){ console.warn('Tests warn',e);} })();
  </script>
</body>
</html>
